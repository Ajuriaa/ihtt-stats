<app-loading class="loading" *ngIf="loading"></app-loading>

<div class="container">
  <div class="filter-wrapper">
    <div class="filter-row">
      <app-date-filter [showDateTypeFilter]="false" (dateRangeChanged)="filterDates($event)"></app-date-filter>
      <!-- Estado de Solicitud -->
      <mat-form-field>
        <mat-label>Estado de Solicitud</mat-label>
        <mat-select [(ngModel)]="selectedFileStatus" (selectionChange)="applyFilter('fileStatus', $event.value)">
          <mat-option value="">TODOS</mat-option>
          <mat-option *ngFor="let status of fileStatuses" [value]="status">
            {{ status }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <!-- Tipo de Trámite -->
      <mat-form-field>
        <mat-label>Tipo de Trámite</mat-label>
        <mat-select [(ngModel)]="selectedProcedureType" (selectionChange)="applyFilter('procedureType', $event.value)">
          <mat-option value="">TODOS</mat-option>
          <mat-option *ngFor="let type of procedureTypes" [value]="type">
            {{ type }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <!-- Código de Ciudad -->
      <mat-form-field>
        <mat-label>Regional</mat-label>
        <mat-select [(ngModel)]="selectedCityCode" (selectionChange)="applyFilter('cityCode', $event.value)">
          <mat-option value="">TODOS</mat-option>
          <mat-option *ngFor="let city of cityOptions" [value]="city">
            {{ city }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div class="filter-row">
      <!-- Categoría - Autocomplete for large dataset -->
      <mat-form-field>
        <mat-label>Categoría de Transporte</mat-label>
        <input matInput [(ngModel)]="selectedCategory" (input)="filterCategories($any($event.target).value)" 
               [matAutocomplete]="categoryAuto" placeholder="Buscar categoría...">
        <mat-autocomplete #categoryAuto="matAutocomplete" (optionSelected)="applyFilter('category', $event.option.value)">
          <mat-option value="">TODAS</mat-option>
          <mat-option *ngFor="let category of filteredCategories" [value]="category">
            {{ category }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
      
      <!-- Clase de Trámite - Autocomplete for large dataset -->
      <mat-form-field>
        <mat-label>Clase de Trámite</mat-label>
        <input matInput [(ngModel)]="selectedProcedureClass" (input)="filterProcedureClasses($any($event.target).value)" 
               [matAutocomplete]="procedureClassAuto" placeholder="Buscar clase de trámite...">
        <mat-autocomplete #procedureClassAuto="matAutocomplete" (optionSelected)="applyFilter('procedureClass', $event.option.value)">
          <mat-option value="">TODOS</mat-option>
          <mat-option *ngFor="let procedureClass of filteredProcedureClasses" [value]="procedureClass">
            {{ procedureClass }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <!-- Nombre del Solicitante -->
      <mat-form-field>
        <input matInput placeholder="Nombre del Solicitante" [(ngModel)]="applicantName">
      </mat-form-field>

      <!-- Nombre de la Empresa -->
      <mat-form-field>
        <input matInput placeholder="Nombre de la Empresa" [(ngModel)]="companyName">
      </mat-form-field>

      <!-- Renovación automática -->
      <mat-form-field>
        <mat-label>Renovación Automática</mat-label>
        <mat-select [(ngModel)]="selectedRenewalState" (selectionChange)="applyFilter('renewalState', $event.value)">
          <mat-option value="">TODOS</mat-option>
          <mat-option *ngFor="let estado of renewalStates" [value]="estado.value">
            {{ estado.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <app-primary-button (btnClick)="onSubmit()">FILTRAR</app-primary-button>
    </div>
  </div>

  <div class="kpi-container">
    <mat-card class="kpi-card">
      <p class="title">{{ totalApplications }}</p>
      <p>Total de Solicitudes</p>
    </mat-card>

    <mat-card class="kpi-card kpi-orange">
      <p class="title">{{ activeApplications }}</p>
      <p>Solicitudes Activas</p>
    </mat-card>

    <mat-card class="kpi-card kpi-green">
      <p class="title">{{ finalizedApplications }}</p>
      <p>Solicitudes Finalizadas</p>
    </mat-card>

    <mat-card class="kpi-card kpi-red">
      <p class="title">{{ inactiveApplications }}</p>
      <p>Solicitudes Inactivas</p>
    </mat-card>
    
    <mat-card class="kpi-card" *ngIf="analytics?.kpis?.totalProcedures">
      <p class="title">{{ analytics?.kpis?.totalProcedures }}</p>
      <p>Total de Trámites</p>
    </mat-card>
  </div>

  <div class="graph-container">
    <div id="statusDistributionChart" style="width: 40%; height: 400px;"></div>
    <div id="monthlyApplicationsChart" style="width: 60%; height: 400px;"></div>
  </div>
  
  <div id="procedureTypeChart" style="width: 100%; height: 400px;"></div>
  
  <div class="graph-container">
    <div id="renewalTypeChart" style="width: 40%; height: 400px;"></div>
    <div id="serviceClassChart" style="width: 60%; height: 400px;"></div>
  </div>

  <div class="kpi-container">
    <mat-card class="kpi-card kpi-blue">
      <p class="title">{{ automaticRenewals }}</p>
      <p>Renovaciones Automáticas</p>
    </mat-card>

    <mat-card class="kpi-card">
      <p class="title">{{ manualApplications }}</p>
      <p>Solicitudes Manuales</p>
    </mat-card>
    
    <mat-card class="kpi-card" *ngIf="errorApplications > 0">
      <p class="title">{{ errorApplications }}</p>
      <p>Con Error de Usuario</p>
    </mat-card>
    
    <mat-card class="kpi-card" *ngIf="estado020Applications > 0">
      <p class="title">{{ estado020Applications }}</p>
      <p>Estado 020</p>
    </mat-card>
  </div>
</div>