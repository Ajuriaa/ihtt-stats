<app-loading class="loading" *ngIf="isLoading"></app-loading>

<div class="container" *ngIf="!isLoading">
  <div class="filter-wrapper">
    <div class="filter-row">
      <app-date-filter [showDateTypeFilter]="false" [startDate]="startDateObject" [endDate]="endDateObject" (dateRangeChanged)="filterDates($event)"></app-date-filter>
      <!-- Estado de Solicitud -->
      <mat-form-field>
        <mat-label>Estado de Solicitud</mat-label>
        <mat-select [(ngModel)]="selectedFileStatus">
          <mat-option value="">TODOS</mat-option>
          <mat-option *ngFor="let status of fileStatuses" [value]="status">
            {{ status }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Tipo de Trámite -->
      <mat-form-field>
        <mat-label>Tipo de Trámite</mat-label>
        <mat-select [(ngModel)]="selectedProcedureType">
          <mat-option value="">TODOS</mat-option>
          <mat-option *ngFor="let type of procedureTypes" [value]="type">
            {{ type }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <!-- Código de Ciudad -->
      <mat-form-field>
        <mat-label>Regional</mat-label>
        <mat-select [(ngModel)]="selectedCityCode">
          <mat-option value="">TODOS</mat-option>
          <mat-option *ngFor="let city of cityOptions" [value]="city">
            {{ city }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div class="filter-row">
      <!-- Categoría - Autocomplete for large dataset -->
      <mat-form-field>
        <mat-label>Categoría de Transporte</mat-label>
        <input matInput [(ngModel)]="selectedCategory" (input)="filterCategories($any($event.target).value)" 
               [matAutocomplete]="categoryAuto" placeholder="Buscar categoría...">
        <mat-autocomplete #categoryAuto="matAutocomplete">
          <mat-option value="">TODAS</mat-option>
          <mat-option *ngFor="let category of filteredCategories" [value]="category">
            {{ category }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
      
      <!-- Clase de Trámite - Autocomplete for large dataset -->
      <mat-form-field>
        <mat-label>Clase de Trámite</mat-label>
        <input matInput [(ngModel)]="selectedProcedureClass" (input)="filterProcedureClasses($any($event.target).value)" 
               [matAutocomplete]="procedureClassAuto" placeholder="Buscar clase de trámite...">
        <mat-autocomplete #procedureClassAuto="matAutocomplete">
          <mat-option value="">TODOS</mat-option>
          <mat-option *ngFor="let procedureClass of filteredProcedureClasses" [value]="procedureClass">
            {{ procedureClass }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <!-- ID de Solicitud -->
      <mat-form-field>
        <input matInput placeholder="ID de Solicitud" [(ngModel)]="applicationId">
      </mat-form-field>

      <!-- Nombre del Solicitante -->
      <mat-form-field>
        <input matInput placeholder="Nombre del Solicitante" [(ngModel)]="applicantName">
      </mat-form-field>

      <!-- Nombre de la Empresa -->
      <mat-form-field>
        <input matInput placeholder="Nombre de la Empresa" [(ngModel)]="companyName">
      </mat-form-field>

      <!-- Renovación automática -->
      <mat-form-field>
        <mat-label>Renovación Automática</mat-label>
        <mat-select [(ngModel)]="selectedRenewalState">
          <mat-option value="">TODOS</mat-option>
          <mat-option *ngFor="let estado of renewalStates" [value]="estado.value">
            {{ estado.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <app-primary-button (btnClick)="onSubmit()">FILTRAR</app-primary-button>
    </div>
  </div>

  <div class="controls">
    <div class="export-buttons">
      <app-primary-button (btnClick)="generatePDF()">GENERAR PDF</app-primary-button>
      <app-primary-button (btnClick)="generateExcel()">EXPORTAR EXCEL</app-primary-button>
    </div>
    <p class="result-count">{{ totalApplications }} resultados encontrados</p>
  </div>

  <app-no-result *ngIf="applications.length === 0"></app-no-result>

  <div *ngIf="applications.length > 0" class="table-container">
    <table mat-table [dataSource]="applications | paginate: { itemsPerPage, currentPage: page }" class="table">

      <!-- Fecha de Recepción Column -->
      <ng-container matColumnDef="receivedDate">
        <th mat-header-cell *matHeaderCellDef class="table-cell title">Fecha de Recepción</th>
        <td mat-cell *matCellDef="let application" class="table-cell pointer">
          {{ application.receivedDate | date:'dd/MM/yyyy' }}
        </td>
      </ng-container>

      <!-- ID de Solicitud Column -->
      <ng-container matColumnDef="applicationId">
        <th mat-header-cell *matHeaderCellDef class="table-cell title">ID de Solicitud</th>
        <td mat-cell *matCellDef="let application" class="table-cell pointer">{{ application.applicationId }}</td>
      </ng-container>

      <!-- Nombre del Solicitante Column -->
      <ng-container matColumnDef="applicantName">
        <th mat-header-cell *matHeaderCellDef class="table-cell title">Solicitante</th>
        <td mat-cell *matCellDef="let application" class="table-cell pointer">{{ application.applicantName || 'N/A' }}</td>
      </ng-container>

      <!-- Nombre de la Empresa Column -->
      <ng-container matColumnDef="companyName">
        <th mat-header-cell *matHeaderCellDef class="table-cell title">Empresa</th>
        <td mat-cell *matCellDef="let application" class="table-cell pointer">{{ application.companyName || 'N/A' }}</td>
      </ng-container>

      <!-- Estado del Expediente Column -->
      <ng-container matColumnDef="fileStatus">
        <th mat-header-cell *matHeaderCellDef class="table-cell title">Estado</th>
        <td mat-cell *matCellDef="let application" class="table-cell pointer">
          <span class="status-badge" [ngClass]="getStatusBadgeClass(application.fileStatus)">
            {{ application.fileStatus || 'N/A' }}
          </span>
        </td>
      </ng-container>

      <!-- Tipo de Trámite Column -->
      <ng-container matColumnDef="procedureTypeDescription">
        <th mat-header-cell *matHeaderCellDef class="table-cell title">Tipo de Trámite</th>
        <td mat-cell *matCellDef="let application" class="table-cell pointer">{{ application.procedureTypeDescription || 'N/A' }}</td>
      </ng-container>

      <!-- Categoría Column -->
      <ng-container matColumnDef="categoryDescription">
        <th mat-header-cell *matHeaderCellDef class="table-cell title">Categoría</th>
        <td mat-cell *matCellDef="let application" class="table-cell pointer">{{ application.categoryDescription || 'N/A' }}</td>
      </ng-container>

      <!-- Renovación Automática Column -->
      <ng-container matColumnDef="isAutomaticRenewal">
        <th mat-header-cell *matHeaderCellDef class="table-cell title">Renovación</th>
        <td mat-cell *matCellDef="let application" class="table-cell pointer">
          <span class="renewal-badge" [ngClass]="getRenewalClass(application.isAutomaticRenewal)">
            {{ getRenewalText(application.isAutomaticRenewal) }}
          </span>
        </td>
      </ng-container>

      <!-- Código de Ciudad Column -->
      <ng-container matColumnDef="cityCode">
        <th mat-header-cell *matHeaderCellDef class="table-cell title">Ciudad</th>
        <td mat-cell *matCellDef="let application" class="table-cell pointer">{{ application.cityCode || 'N/A' }}</td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <pagination-controls
      *ngIf="applications.length > 0"
      class="my-pagination"
      (pageChange)="onPageChange($event)"
      previousLabel="Anterior"
      nextLabel="Siguiente"
    ></pagination-controls>
  </div>
</div>
