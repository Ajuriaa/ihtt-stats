<div class="container">
  <div class="content">
    <!-- Filtros de fecha -->
    <app-date-filter
      [showDateTypeFilter]="false"
      (dateRangeChanged)="filterDates($event)">
    </app-date-filter>

    <!-- Filtros adicionales -->
    <form (ngSubmit)="onSubmit()" class="filters-form">
      <!-- RTN del Solicitante -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>RTN del Solicitante</mat-label>
        <input matInput [(ngModel)]="rtn" name="rtn" placeholder="Ingrese RTN">
      </mat-form-field>

      <!-- Nombre del Solicitante -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Nombre del Solicitante</mat-label>
        <input matInput [(ngModel)]="applicantName" name="applicantName" placeholder="Ingrese nombre">
      </mat-form-field>

      <!-- Estado del Permiso -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Estado del Permiso</mat-label>
        <mat-select [(value)]="selectedPermitStatus" (selectionChange)="applyFilter('permitStatus', $event.value)">
          <mat-option value="">Todos</mat-option>
          <mat-option *ngFor="let status of permitStatuses" [value]="status">{{ status }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Tipo de Servicio -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Tipo de Servicio</mat-label>
        <mat-select [(value)]="selectedServiceType" (selectionChange)="applyFilter('serviceType', $event.value)">
          <mat-option value="">Todos</mat-option>
          <mat-option *ngFor="let serviceType of serviceTypes" [value]="serviceType">{{ serviceType }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Botón de filtro -->
      <app-primary-button
        type="submit"
        [disableButton]="isLoading"
        text="Aplicar Filtros">
      </app-primary-button>
    </form>

    <!-- Tabla de permisos -->
    <div class="table-container">
      <table mat-table [dataSource]="permits | paginate: { itemsPerPage, currentPage: page }" class="permits-table">

        <!-- Columna de Fecha del Sistema -->
        <ng-container matColumnDef="systemDate">
          <th mat-header-cell *matHeaderCellDef>Fecha del Sistema</th>
          <td mat-cell *matCellDef="let permit">{{ getDate(permit.systemDate) }}</td>
        </ng-container>

        <!-- Columna de Código de Permiso -->
        <ng-container matColumnDef="permitCode">
          <th mat-header-cell *matHeaderCellDef>Código de Permiso</th>
          <td mat-cell *matCellDef="let permit">{{ permit.permitCode || 'N/A' }}</td>
        </ng-container>

        <!-- Columna de Nombre del Solicitante -->
        <ng-container matColumnDef="applicantName">
          <th mat-header-cell *matHeaderCellDef>Solicitante</th>
          <td mat-cell *matCellDef="let permit">{{ permit.applicantName || 'N/A' }}</td>
        </ng-container>

        <!-- Columna de RTN -->
        <ng-container matColumnDef="rtn">
          <th mat-header-cell *matHeaderCellDef>RTN</th>
          <td mat-cell *matCellDef="let permit">{{ permit.rtn || 'N/A' }}</td>
        </ng-container>

        <!-- Columna de Tipo de Servicio -->
        <ng-container matColumnDef="serviceTypeDescription">
          <th mat-header-cell *matHeaderCellDef>Tipo de Servicio</th>
          <td mat-cell *matCellDef="let permit">{{ permit.serviceTypeDescription || 'N/A' }}</td>
        </ng-container>

        <!-- Columna de Estado -->
        <ng-container matColumnDef="permitStatus">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let permit">
            <span [class]="getStatusColor(permit.permitStatus)">
              {{ permit.permitStatus || 'N/A' }}
            </span>
          </td>
        </ng-container>

        <!-- Columna de Oficina Regional -->
        <ng-container matColumnDef="regionalOffice">
          <th mat-header-cell *matHeaderCellDef>Oficina Regional</th>
          <td mat-cell *matCellDef="let permit">{{ permit.regionalOffice || 'N/A' }}</td>
        </ng-container>

        <!-- Columna de Monto -->
        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>Monto</th>
          <td mat-cell *matCellDef="let permit">{{ formatCurrency(permit.amount) }}</td>
        </ng-container>

        <!-- Columna de Código de Aviso -->
        <ng-container matColumnDef="noticeCode">
          <th mat-header-cell *matHeaderCellDef>Código de Aviso</th>
          <td mat-cell *matCellDef="let permit">{{ permit.noticeCode || 'N/A' }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <!-- Mensaje cuando no hay resultados -->
      <app-no-result
        *ngIf="permits.length === 0 && !isLoading"
        message="No se encontraron permisos eventuales con los filtros aplicados.">
      </app-no-result>
    </div>

    <!-- Paginación -->
    <pagination-controls
      *ngIf="permits.length > 0"
      class="my-pagination"
      (pageChange)="onPageChange($event)"
      previousLabel="Anterior"
      nextLabel="Siguiente">
    </pagination-controls>
  </div>

  <!-- Loading overlay -->
  <app-loading *ngIf="isLoading"></app-loading>
</div>
